name: Code Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ========================
  # QUALITY GATE: CODE STYLE  
  # ========================
  code-style:
    name: ğŸ¨ Code Style
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: ğŸ“¦ Install Poetry
      uses: snok/install-poetry@v1

    - name: ğŸ“š Install Dependencies
      run: poetry install --with dev

    - name: ğŸ¨ Check Black Formatting
      run: poetry run black --check --diff .

    - name: ğŸ”§ Check Import Sorting
      run: poetry run isort --check-only --diff .

    - name: ğŸ“ Flake8 Linting
      run: poetry run flake8 .

  # ========================
  # QUALITY GATE: DEPENDENCIES
  # ========================
  dependency-check:
    name: ğŸ”’ Dependency Security
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: ğŸ“¦ Install Poetry
      uses: snok/install-poetry@v1

    - name: ğŸ“š Install Dependencies
      run: poetry install --with dev

    - name: ğŸ›¡ï¸ Check for Vulnerabilities
      run: |
        poetry run safety check --json --output safety-report.json || true
        if [ -f safety-report.json ]; then
          echo "ğŸ“‹ Safety report generated"
          cat safety-report.json
        fi

    - name: ğŸ“‹ Upload Safety Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: safety-report
        path: safety-report.json

  # ========================
  # QUALITY GATE: COMPLEXITY
  # ========================
  complexity-check:
    name: ğŸ§® Complexity Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: ğŸ“¦ Install Poetry
      uses: snok/install-poetry@v1

    - name: ğŸ“š Install Dependencies
      run: |
        poetry install --with dev
        pip install radon xenon

    - name: ğŸ§® Cyclomatic Complexity
      run: |
        echo "ğŸ“Š Analyzing cyclomatic complexity..."
        radon cc . --min B --show-complexity --total-average
        
    - name: ğŸ¯ Maintainability Index
      run: |
        echo "ğŸ“ˆ Calculating maintainability index..."
        radon mi . --min B --show --multi

    - name: âš ï¸ Complexity Threshold Check
      run: |
        echo "ğŸš¨ Checking complexity thresholds..."
        xenon --max-absolute B --max-modules B --max-average A .

  # ========================
  # QUALITY GATE: DOCUMENTATION
  # ========================
  documentation-check:
    name: ğŸ“š Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ“‹ Check Required Files
      run: |
        echo "ğŸ“‹ Checking for required documentation files..."
        
        files=("README.md" "COVERAGE_REPORT.md" "DOCKER_README.md")
        missing_files=()
        
        for file in "${files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          else
            echo "âœ… Found: $file"
          fi
        done
        
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo "âŒ Missing files:"
          printf '%s\n' "${missing_files[@]}"
          exit 1
        else
          echo "âœ… All required documentation files present"
        fi

    - name: ğŸ“ Check Docstring Coverage
      run: |
        echo "ğŸ“ Checking docstring coverage..."
        pip install docstring-coverage
        docstring-coverage . --skip-magic --skip-private --skip-init || true

  # ========================
  # QUALITY GATE: TYPE HINTS
  # ========================
  type-check:
    name: ğŸ·ï¸ Type Checking
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: ğŸ“¦ Install Poetry
      uses: snok/install-poetry@v1

    - name: ğŸ“š Install Dependencies
      run: |
        poetry install --with dev
        pip install mypy django-stubs djangorestframework-stubs

    - name: ğŸ·ï¸ MyPy Type Checking
      run: |
        echo "ğŸ·ï¸ Running MyPy type checker..."
        mypy . --ignore-missing-imports --no-strict-optional --show-error-codes || true

  # ========================
  # QUALITY SUMMARY
  # ========================
  quality-summary:
    name: ğŸ“Š Quality Summary
    runs-on: ubuntu-latest
    needs: [code-style, dependency-check, complexity-check, documentation-check, type-check]
    if: always()
    
    steps:
    - name: ğŸ“Š Generate Quality Report
      run: |
        echo "# ğŸ“Š Code Quality Summary" > quality-summary.md
        echo "" >> quality-summary.md
        echo "| Check | Status |" >> quality-summary.md
        echo "|-------|--------|" >> quality-summary.md
        echo "| ğŸ¨ Code Style | ${{ needs.code-style.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> quality-summary.md
        echo "| ğŸ”’ Dependencies | ${{ needs.dependency-check.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> quality-summary.md
        echo "| ğŸ§® Complexity | ${{ needs.complexity-check.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> quality-summary.md
        echo "| ğŸ“š Documentation | ${{ needs.documentation-check.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> quality-summary.md
        echo "| ğŸ·ï¸ Type Hints | ${{ needs.type-check.result == 'success' && 'âœ… PASS' || 'âŒ FAIL' }} |" >> quality-summary.md
        
        cat quality-summary.md

    - name: ğŸ“‹ Upload Quality Summary
      uses: actions/upload-artifact@v4
      with:
        name: quality-summary
        path: quality-summary.md

    - name: âœ… Quality Gate Status
      run: |
        if [[ "${{ needs.code-style.result }}" == "success" && 
              "${{ needs.dependency-check.result }}" == "success" && 
              "${{ needs.documentation-check.result }}" == "success" ]]; then
          echo "âœ… Quality Gate: PASSED"
        else
          echo "âŒ Quality Gate: FAILED"
          echo "Please fix the failing checks before merging."
          exit 1
        fi